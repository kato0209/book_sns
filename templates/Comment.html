{% extends 'base.html' %}
{% load static %}

{% block head %}
<link href="{% static 'Comment.css' %}" rel="stylesheet"> 
<link href="{% static 'up_button.css' %}" rel="stylesheet"> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{% endblock head %}

{% block title %}
コメントページ
{% endblock title %}


{% block content %}
<main>
  <!-- 本文 -->
    <div class="tweet-container container myborder border-secondary">
        <p class="font-bold d-flex">
          <img src="{{ tweet.user.ProfileImage.url }}" class="user-icon me-3">
          {{ tweet.user.username }} 
          {% if user == tweet.user %}
          <button type="button" class="btn btn-danger del_confirm" data-bs-toggle="modal" data-bs-target="#DeleteModal"  data-deleteurl="{% url 'TweetDelete' tweet.id %}">削除</button>
          {% endif %}
        </p>
        <p class="tweet-text">{{ tweet.content | linebreaksbr }}</p>
        <div class="d-flex book-container border border-secondary">
          <img src="{{ tweet.book.imageUrl }}" alt="" class="book-img me-3">
          <div>
           <h6><a href="{{ tweet.book.itemUrl }}" class="book-title">{{ tweet.book.title}}</a></h6>
           <p class="text-primary">{{ tweet.book.author }}</p>
          </div>
       </div>
      <div class="d-flex">
        <form action="{% url 'like' %}" method="POST" class="d-flex">{% csrf_token %}
            {% if liked %}
                <button id="like" name="{{tweet.id}}" data-like-type="MainLike"><i class="fas fa-lg fa-heart like-after"></i></button>
            {% else %}
                <button id="like" name="{{tweet.id}}" data-like-type="MainLike"><i class="far fa-lg fa-heart like-before"></i></button>      
            {% endif %}
            <p name="{{tweet.id}}-count" class="count"> {{ tweet.like_set.count }} </p>
        </form>
        <div class="stars ms-auto" name="{{ tweet.rating }}">
          <span class="star" name="1">★</span>
          <span class="star" name="2">★</span>
          <span class="star" name="3">★</span>
          <span class="star" name="4">★</span>
          <span class="star" name="5">★</span>
        </div>
      </div>
    </div>
<!--------------------------------->
<!-- 本文に対するコメント -->
    {% for comment in comment_list %}
    <div class="tweet-container container myborder border-secondary">
        <p class="font-bold d-flex">
          <img src="{{ comment.user.ProfileImage.url }}" class="user-icon me-3">
          {{ comment.user.username }} 
          {% if user == comment.user %}
          <button type="button" class="btn btn-danger del_confirm" data-bs-toggle="modal" data-bs-target="#DeleteModal"  data-deleteurl="{% url 'CommentDelete' comment.id %}">削除</button>
          {% endif %}
        </p>
       <p class="tweet-text">{{ comment.text | linebreaksbr }}</p>

      <div class="d-flex">
        <form action="{% url 'like' %}" method="POST" class="d-flex">{% csrf_token %}
            {% if comment.id in liked_list %}
                <button id="like" name="{{comment.id}}" data-like-type="SubLike"><i class="fas fa-lg fa-heart like-after"></i></button>
            {% else %}
                <button id="like" name="{{comment.id}}" data-like-type="SubLike"><i class="far fa-lg fa-heart like-before"></i></button>      
            {% endif %}
            <p name="{{comment.id}}-count" class="count"> {{ comment.like_set.count }} </p>
        </form>
      </div>
    </div>
    {% endfor %}
    <!-------------------------------->

    <button id="UpButton"><i class="fas fa-angle-double-up"></i></button>
</main>


<!-- 下部のbar -->
<footer class="footer mt-auto py-3 fixed-bottom">
 <div class="container">
    <form method="POST" enctype="multipart/form-data" class="d-flex">{% csrf_token %}
      {{form.text}}
        <div class="d-flex">
         <button class="btn btn-success ms-auto" type="submit" id="submit-button">送信</button>
        </div>
    </form>
 </div>
</footer>

<!-- DeleteModal -->
<div class="modal fade" id="DeleteModal" tabindex="-1" aria-labelledby="DeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="DeleteModalLabel">確認</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          本当に削除してよろしいですか?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          <a href="#" class="btn btn-danger" id="del_url">OK</a>
        </div>
      </div>
    </div>
  </div>

  {% endblock content %}

{% block footer %}
<script src="{% static 'up_button.js' %}"></script>
<script src="{% static 'Comment.js' %}"></script>
<script src="{% static 'tweet.js' %}"></script>

<!--いいね機能のAjax処理-->
<script type="text/javascript">
    $(document).ready(function(event){
      $(document).on('click', '#like', function(event){
        event.preventDefault();
          $.ajax({
              type: 'POST',
              url: "{% url 'like' %}",
              data: {
                  'id': $(this).attr('name'),
                  'like-type':$(this).data('like-type'),
                  'csrfmiddlewaretoken': '{{ csrf_token }}'},
              dataType: 'json'
          })
          .done(function(response){
              selector = document.getElementsByName(response.id);
                      if(response.liked){
                          $(selector).html("<i class='fas fa-lg fa-heart like-after'></i>");
                      }
                      else {
                          $(selector).html("<i class='far fa-lg fa-heart like-before'></i>");
                      }
                      selector2 = document.getElementsByName(response.id + "-count");
                      $(selector2).text(response.count);
          })
          .fail(function (jqXHR, textStatus, errorThrown) {
              console.log("ajax通信に失敗しました");
              console.log("jqXHR          : " + jqXHR.status); 
              console.log("textStatus     : " + textStatus);    
              console.log("errorThrown    : " + errorThrown.message); 
              console.log("URL            : " + url);
      });
               
      });
    });
    </script>



{% endblock footer %}



